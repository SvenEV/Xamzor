@inherits UIElement

<div id="@Id" class="@CssClass" style="@LayoutCss" ref="LayoutRoot">@if (Text != null)
    {
        @Text
    }
    else
    {
        @ChildContent
    }
</div>

@functions{

    public static readonly PropertyKey ForegroundProperty = PropertyKey.Create<string, TextBlock>(nameof(Foreground), "black");
    public static readonly PropertyKey FontFamilyProperty = PropertyKey.Create<string, TextBlock>(nameof(FontFamily), "Segoe UI");
    public static readonly PropertyKey FontSizeProperty = PropertyKey.Create<double, TextBlock>(nameof(FontSize), 16);
    public static readonly PropertyKey FontWeightProperty = PropertyKey.Create<FontWeight, TextBlock>(nameof(FontWeight), FontWeight.Normal);
    public static readonly PropertyKey FontStyleProperty = PropertyKey.Create<FontStyle, TextBlock>(nameof(FontStyle), FontStyle.Normal);
    public static readonly PropertyKey TextWrappingProperty = PropertyKey.Create<TextWrapping, TextBlock>(nameof(TextWrapping), TextWrapping.WrapWholeWords);
    public static readonly PropertyKey TextTrimmingProperty = PropertyKey.Create<TextTrimming, TextBlock>(nameof(TextTrimming), TextTrimming.None);
    public static readonly PropertyKey IsTextSelectionEnabledProperty = PropertyKey.Create<bool, TextBlock>(nameof(IsTextSelectionEnabled), false);
    public static readonly PropertyKey TextProperty = PropertyKey.Create<string, TextBlock>(nameof(Text));

    [Parameter] protected string Foreground { get => Properties.Get<string>(ForegroundProperty); set => Properties.Set(ForegroundProperty, value); }
    [Parameter] protected string FontFamily { get => Properties.Get<string>(FontFamilyProperty); set => Properties.Set(FontFamilyProperty, value); }
    [Parameter] protected double FontSize { get => Properties.Get<double>(FontSizeProperty); set => Properties.Set(FontSizeProperty, value); }
    [Parameter] protected FontWeight FontWeight { get => Properties.Get<FontWeight>(FontWeightProperty); set => Properties.Set(FontWeightProperty, value); }
    [Parameter] protected FontStyle FontStyle { get => Properties.Get<FontStyle>(FontStyleProperty); set => Properties.Set(FontStyleProperty, value); }
    [Parameter] protected TextWrapping TextWrapping { get => Properties.Get<TextWrapping>(TextWrappingProperty); set => Properties.Set(TextWrappingProperty, value); }
    [Parameter] protected TextTrimming TextTrimming { get => Properties.Get<TextTrimming>(TextTrimmingProperty); set => Properties.Set(TextTrimmingProperty, value); }
    [Parameter] protected bool IsTextSelectionEnabled { get => Properties.Get<bool>(IsTextSelectionEnabledProperty); set => Properties.Set(IsTextSelectionEnabledProperty, value); }
    [Parameter] protected string Text { get => Properties.Get<string>(TextProperty); set => Properties.Set(TextProperty, value); }

    protected override void ComputeOwnLayoutCss(System.Text.StringBuilder sb)
    {
        base.ComputeOwnLayoutCss(sb);

        if (FontFamily != null)
            sb.Append($"font-family: {FontFamily}; ");

        sb.Append($"font-size: {FontSize}px; ");

        if (Foreground != null)
            sb.Append($"color: {Foreground}; ");

        if (FontWeight != FontWeight.Normal)
            sb.Append($"font-weight: {(int)FontWeight}; ");

        if (FontStyle != FontStyle.Normal)
            sb.Append($"font-style: {FontStyle.ToString().ToLower()}; ");

        sb.Append($"white-space: {(TextWrapping == TextWrapping.NoWrap ? "nowrap" : "pre-line")}; ");

        if (TextWrapping == TextWrapping.Wrap)
            sb.Append($"overflow-wrap: break-word; ");

        if (TextTrimming != TextTrimming.None)
            sb.Append($"text-overflow: ellipsis; ");

        if (!IsTextSelectionEnabled)
            sb.Append("user-select: none; -ms-user-select: none; cursor: default; ");
    }

    protected override Point MeasureOverride(Point availableSize)
    {
        if (Text == null && ChildContent == null)
            return Point.Zero;

        // TODO: How to measure ChildContent?

        var sizeString = RegisteredFunction.Invoke<string>("Xamzor.measureHtml",
            $"<div style=\"{StyleCss} max-width: {availableSize.X}px; max-height: {availableSize.Y}px;\">{Text}</div>");

        var sizeParts = sizeString.Split(',');

        var size = Point.Min(availableSize, new Point(
            double.Parse(sizeParts[0]),
            double.Parse(sizeParts[1])));

        UILog.Write("TEXT", $"Measured a size of {size} for text '{Text}'");

        return size;
    }
}